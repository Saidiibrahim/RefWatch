name: CI

on:
  push:
  pull_request:
  schedule:
    # 03:00 Australia/Adelaide during DST (ACDT, UTC+10:30). During ACST this runs at 02:30 local.
    - cron: "30 16 * * *"

jobs:
  macos:
    if: github.event_name != 'schedule'
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate CI xcconfig
        run: |
          set -euo pipefail
          CONFIG_DIR="RefWatchiOS/Config"
          CONFIG_FILE="$CONFIG_DIR/Config.xcconfig"
          if [ ! -f "$CONFIG_FILE" ]; then
            mkdir -p "$CONFIG_DIR"
            cat > "$CONFIG_FILE" <<'EOF'
          // CI configuration (auto-generated)
          // Safe defaults for simulator builds. Do not commit.
          #include? "Secrets.xcconfig"
          DEVELOPMENT_TEAM =
          BUNDLE_ID_PREFIX = com.refwatch.ci
          APP_GROUP_ID = group.refwatch.shared
          URL_SCHEME = refwatch
          EOF
          fi

      - name: Compute changed Swift files
        run: |
          set -euo pipefail
          git fetch origin main --depth=1
          base="$(git merge-base HEAD origin/main)"
          git diff --name-only --diff-filter=d "$base"...HEAD -- '*.swift' > "$RUNNER_TEMP/swift-files.txt"
          echo "SWIFT_LINT_FILELIST=$RUNNER_TEMP/swift-files.txt" >> "$GITHUB_ENV"
          count="$(wc -l < "$RUNNER_TEMP/swift-files.txt" | tr -d ' ')"
          echo "Changed Swift files: $count"
          if [ "$count" -gt 0 ]; then
            cat "$RUNNER_TEMP/swift-files.txt"
          fi

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Configure git for SPM
        run: |
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Cache SwiftPM packages
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/spm-cache
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: ${{ runner.os }}-spm-

      - name: Show toolchain
        run: |
          sw_vers
          xcodebuild -version
          swift --version

      - name: Install SwiftLint / SwiftFormat
        run: |
          brew install swiftlint swiftformat

      - name: Lint
        run: |
          set -euo pipefail
          if [ ! -s "$SWIFT_LINT_FILELIST" ]; then
            echo "No changed Swift files; skipping SwiftLint/SwiftFormat."
            exit 0
          fi
          python3 - <<'PY'
          import os
          import subprocess
          import sys

          filelist = os.environ.get("SWIFT_LINT_FILELIST")
          if not filelist:
            print("SWIFT_LINT_FILELIST not set; skipping lint.")
            sys.exit(0)

          with open(filelist) as handle:
            files = [line.strip() for line in handle if line.strip()]

          files = [path for path in files if os.path.exists(path)]

          if not files:
            print("No changed Swift files; skipping lint.")
            sys.exit(0)

          for path in files:
            subprocess.run(["swiftlint", "lint", "--config", ".swiftlint.yml", path], check=True)

          subprocess.run(["swiftformat", "--lint", "--config", ".swiftformat", *files], check=True)
          PY

      # TODO: iOS tests removed due to simulator stability issues (CoreData crashes).
      # See: https://github.com/Saidiibrahim/RefWatch/actions/runs/20891158644
      # Consider adding simulator reset (xcrun simctl erase) before tests when re-enabling.

      - name: watchOS build
        run: |
          set -euo pipefail
          xcodebuild build \
            -project RefWatch.xcodeproj \
            -scheme "RefWatch Watch App" \
            -destination "generic/platform=watchOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

  watchos-tests:
    if: github.event_name == 'schedule'
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate CI xcconfig
        run: |
          set -euo pipefail
          CONFIG_DIR="RefWatchiOS/Config"
          CONFIG_FILE="$CONFIG_DIR/Config.xcconfig"
          if [ ! -f "$CONFIG_FILE" ]; then
            mkdir -p "$CONFIG_DIR"
            cat > "$CONFIG_FILE" <<'EOF'
          // CI configuration (auto-generated)
          // Safe defaults for simulator builds. Do not commit.
          #include? "Secrets.xcconfig"
          DEVELOPMENT_TEAM =
          BUNDLE_ID_PREFIX = com.refwatch.ci
          APP_GROUP_ID = group.refwatch.shared
          URL_SCHEME = refwatch
          EOF
          fi

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Configure git for SPM
        run: |
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Cache SwiftPM packages
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/spm-cache
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: ${{ runner.os }}-spm-

      - name: Show toolchain
        run: |
          sw_vers
          xcodebuild -version
          swift --version

      - name: Ensure watchOS runtime
        run: |
          set -euo pipefail
          if xcrun simctl list runtimes -j | python3 -c 'import json, sys; data=json.load(sys.stdin); runtimes=data.get("runtimes") or []; has_watch=any(rt.get("platform")=="watchOS" and rt.get("isAvailable") for rt in runtimes); sys.exit(0 if has_watch else 1)'
          then
            echo "watchOS runtime already installed."
          else
            echo "watchOS runtime missing; downloading..."
            for attempt in 1 2 3; do
              echo "Attempt $attempt/3: xcodebuild -downloadPlatform watchOS"
              if python3 -c 'import subprocess, sys; subprocess.run(["xcodebuild", "-downloadPlatform", "watchOS"], check=True, timeout=900)'
              then
                break
              fi
              if [ "$attempt" -eq 3 ]; then
                echo "Failed to download watchOS runtime after 3 attempts."
                exit 1
              fi
              sleep $((attempt * 10))
            done
          fi

      - name: Select paired watchOS simulator
        run: |
          set -euo pipefail
          DEST_ID="$(
            python3 - <<'PY'
          import json
          import subprocess
          import sys

          def sh(args: list[str]) -> str:
            return subprocess.check_output(args, text=True).strip()

          data = json.loads(sh(["xcrun", "simctl", "list", "-j"]))
          devices = data.get("devices") or {}
          pairs = data.get("pairs") or {}

          device_map = {}
          for devs in devices.values():
            for dev in devs or []:
              udid = dev.get("udid")
              if udid:
                device_map[udid] = dev

          candidates = []
          for pair in pairs.values():
            watch = (pair or {}).get("watch") or {}
            phone = (pair or {}).get("phone") or {}
            watch_udid = watch.get("udid")
            phone_udid = phone.get("udid")
            if not watch_udid or not phone_udid:
              continue
            watch_dev = device_map.get(watch_udid) or {}
            phone_dev = device_map.get(phone_udid) or {}
            if not watch_dev.get("isAvailable") or not phone_dev.get("isAvailable"):
              continue
            watch_name = str(watch_dev.get("name") or "")
            phone_name = str(phone_dev.get("name") or "")
            if not watch_name.startswith("Apple Watch") or not phone_name.startswith("iPhone"):
              continue
            candidates.append((watch_name, watch_udid))

          candidates.sort(key=lambda it: it[0])
          if not candidates:
            print("No paired watchOS simulators found.", file=sys.stderr)
            sys.exit(1)
          print(candidates[0][1])
          PY
          )"
          echo "WATCH_DEST_ID=$DEST_ID" >> "$GITHUB_ENV"

      - name: watchOS tests
        run: |
          set -euo pipefail
          if [ -z "$WATCH_DEST_ID" ]; then
            echo "No watchOS simulator available."
            exit 1
          fi

          RESULT_BUNDLE_PATH="$RUNNER_TEMP/RefWatch-watchOS.xcresult"
          for attempt in 1 2 3; do
            if xcodebuild -resolvePackageDependencies \
              -project RefWatch.xcodeproj \
              -scheme "RefWatch Watch App" \
              -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm-cache"
            then
              break
            fi
            if [ "$attempt" -eq 3 ]; then
              echo "Failed to resolve SwiftPM dependencies after 3 attempts."
              exit 1
            fi
            sleep $((attempt * 10))
          done
          xcodebuild test \
            -project RefWatch.xcodeproj \
            -scheme "RefWatch Watch App" \
            -destination "platform=watchOS Simulator,id=$WATCH_DEST_ID" \
            -enableCodeCoverage YES \
            -disableAutomaticPackageResolution \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm-cache" \
            -resultBundlePath "$RESULT_BUNDLE_PATH"
