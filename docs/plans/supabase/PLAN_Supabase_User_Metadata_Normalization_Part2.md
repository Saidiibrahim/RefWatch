# Supabase User Metadata Normalization â€“ Follow-up Plan

## Context
- Part 1 added typed provider columns, normalization trigger, and client-side metadata sanitization.
- Sign-in still fails due to JSON type drift, migration 0015 is not registered with Supabase, and scheduled match syncing now errors on decode.
- Goal: deliver a clean end-to-end flow where users synchronize successfully and scheduling APIs remain functional.

## Tasks

### 1. Fix iOS Profile Upsert Payload
- [x] ðŸ›  Update `SupabaseUserProfileSynchronizer.metadataJSON` to unwrap `[String: AnyCodable]` into plain `[String: Any]` before normalization (`RefZoneiOS/Core/Platform/Supabase/SupabaseUserProfileSynchronizer.swift`).
- [x] ðŸ§ª Add regression coverage that encodes a real `Session` fixture and asserts boolean fields serialize correctly (`RefZoneiOSTests/SupabaseUserProfileSynchronizerTests.swift`).
- [ ] âœ… Re-run sign-in (Apple + Google) to confirm the `public.users` constraint no longer trips. _Pending manual QA once build/test blockers are cleared; see verification notes below._

### 2. Match Provider Normalization Semantics
- [x] ðŸ” Lowercase and dedupe provider arrays in `normalizeProviders`, mirroring the database trigger.
- [x] ðŸ§ª Extend tests with mixed-case/duplicate providers to prove stability.

### 3. Register Migration 0015 Through Supabase MCP
- [x] ðŸ“¦ Use the Supabase MCP (`supabase__apply_migration` / `supabase__list_migrations`) to apply `0015_user_metadata_normalization.sql`; migration now appears server-side (version `0015_user_metadata_normalization`).
- [x] ðŸ” Verified plan SQL matches deployed function via `pg_get_functiondef`.
- [x] ðŸ—’ No new artifacts generated by Supabase; repository SQL remains canonical.

### 4. Align Deployed Trigger With Planned Logic
- [x] ðŸ”„ Replaced `public.normalize_user_provider_metadata()` with the planned version via MCP.
- [x] ðŸ§¹ Backfilled `public.users` and re-ran the lightweight `UPDATE public.users SET raw_app_metadata = raw_app_metadata;` to re-trigger normalization.

### 5. Resolve Scheduled Match Upsert Decoding Failure
- [x] ðŸªª Added structured logging of raw `.upsert` payloads for scheduled matches (`SupabaseScheduleAPI.syncScheduledMatch`).
- [x] ðŸ”§ Updated `SupabaseScheduleAPI` decoder to tolerate Postgres-style timestamps and wrapped responses; added `SupabaseScheduleAPITests` coverage.
- [ ] âœ… Validate scheduled match pushes succeed without retries. _Automated verification blocked by existing `RefZoneiOS` build errors (see Testing section); manual end-to-end push still required._

### 6. Regression Sweep & Documentation
- [ ] ðŸ” Re-test end-to-end sign-in and scheduling flows on a clean simulator. _Dependent on resolving unrelated build failures in `SupabaseMatchHistoryRepository`._
- [ ] âœ… Confirm `public.users` rows retain normalized JSON and typed columns after multiple sign-ins. _Needs QA sign-off post manual test run._
- [x] ðŸ“ Update plan notes / release docs with the final state and any schema adjustments (this document).

## Verification Notes
- CI-side unit tests are blocked by existing build failures in `SupabaseMatchHistoryRepository.swift` (missing local symbols). Once resolved, re-run `xcodebuild test -project RefZone.xcodeproj -scheme RefZoneiOS -destination 'platform=iOS Simulator,name=iPhone 16'`.
- Manual sign-in verification: launch the iOS app, sign out/in with Apple and Google, and confirm no constraint violations in `public.users`. Spot-check the row to ensure `provider_list` contains lowercase, deduped values and that `raw_app_metadata -> providers` is an array of the same values.
- Schedule push verification: on a clean device, create a scheduled match and ensure the first push succeeds (no retries). The OSLog category `Supabase` now records the raw upsert payload to aid troubleshooting.

## Exit Criteria
- App sign-in completes without constraint violations; `public.users` reflects normalized metadata.
- Migration history includes `0015_user_metadata_normalization` and matches repo SQL.
- Schedule sync no longer logs `"The data couldnâ€™t be read because it isnâ€™t in the correct format."`
- Tests cover the new metadata handling edge cases.
You are a senior developer on the RefZone iOS team. Your task is to finish the user metadata normalization follow-up work.

- Primary reference: `docs/plans/supabase/PLAN_Supabase_User_Metadata_Normalization_Part2.md`. Treat each task section as acceptance criteria; please check them off as you go.
- Start by fixing `SupabaseUserProfileSynchronizer`: unwrap `[String: AnyCodable]` in `metadataJSON`, update provider normalization (lowercase/dedupe), and extend the existing unit tests so the encoded payload contains real booleans and normalized provider arrays. Run the tests afterward.
- Use the Supabase MCP to register `0015_user_metadata_normalization.sql`. Confirm it appears via `supabase__list_migrations`, and bring the deployed trigger back in sync with the SQL in the plan. Remember to backfill `public.users` once the trigger is updated.
- Investigate the scheduled match push failure: capture the raw `.upsert` response, adjust DTOs/decoding so we accept the returned shape, and verify the app can push a schedule without retries.
- Leave the plan file updated with any noteworthy schema or test coverage changes before wrapping up.
- QA note: a separate tester will re-run sign-in (Apple & Google) and the full schedule sync flow to confirm no regressions; capture any verification guidance theyâ€™ll need.
